Rathole Tunnel Optimization and Crash Prevention
=============================================

I have analyzed and optimized the `rathole-tunnel.sh` script to address crashing issues and improve performance.

Key Changes and Improvements:

1.  Individual Systemd Services (Kharej/Client Side):
    - Migrated from a single fragile service to individual systemd units (e.g., `rathole-kharej-s1.service`).
    - This allows independent monitoring and automatic recovery of each tunnel.
    - Added automated cleanup of orphaned services when re-configuring tunnels.
    - Fixed configuration file collisions when using multiple IRAN servers with the same tunnel port.

2.  Service Hardening:
    - Increased resource limits for all rathole services:
        * `LimitNOFILE=1048576` (Prevents "Too many open files" crashes)
        * `LimitNPROC=infinity`
        * `TasksMax=infinity`
    - Enhanced restart policy:
        * `Restart=always`
        * `RestartSec=5s`
        * `StartLimitIntervalSec=0` (Ensures continuous recovery attempts)

3.  System-Wide Performance Optimizations:
    - Added `apply_instant_optimizations` function to apply and persist critical network tweaks:
        * TCP BBR Congestion Control for high-speed tunneling.
        * Increased `net.core.somaxconn` and `net.core.netdev_max_backlog`.
        * Increased `fs.file-max` for handling high connection volume.
        * Enabled TCP Fast Open.
    - Optimizations are now persistent across reboots via `/etc/sysctl.d/99-rathole.conf`.

4.  Rathole Tunneling Optimizations:
    - Added TCP keepalive settings (`keepalive_secs = 20`, `keepalive_interval = 8`) to the configuration, helping tunnels stay alive through firewalls and DPI.
    - Increased `retry_interval` to 5 seconds for more stable reconnection cycles.

5.  Improved Binary Management:
    - Updated the download logic to fetch the latest official releases from the official `rathole-org` GitHub repository, ensuring your servers always run the most stable and up-to-date version of Rathole.

6.  Robust Management Functions:
    - Refactored `destroy_tunnel`, `check_tunnel_status`, and `restart_services` to correctly manage multiple individual service instances.
    - Improved the reset cron-job to safely restart all active rathole services via systemd.

These improvements provide a production-grade tunneling environment that is resilient to network fluctuations and resource exhaustion.
